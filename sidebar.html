<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Copilot</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 8px; }
    #header { display:flex; gap:8px; align-items:center; }
    textarea { width:100%; min-height:80px; }
    .small { font-size:0.9rem; color: #666; }
  </style>
</head>
<body>
  <div id="header">
    <h3>Copilot</h3>
    <button id="toggle">Collapse</button>
  </div>

  <div>
    <label class="small">OpenAI API Key (stored locally)</label><br/>
    <input id="apiKey" placeholder="sk-..." style="width:100%"/>
    <button id="saveKey">Save key</button>
    <div id="keyStatus" class="small"></div>
  </div>

  <hr/>

  <div>
    <button id="readCurrent">Read current email</button>
    <pre id="messageSummary" class="small"></pre>
  </div>

  <hr/>

  <div>
    <label>Ask Copilot</label><br/>
    <textarea id="prompt" placeholder="Summarize the current email and propose calendar events"></textarea>
    <button id="ask">Ask (use key to call OpenAI)</button>
    <div id="aiResponse" class="small"></div>
  </div>

  <hr/>

  <div>
    <label>Search messages (subject contains)</label><br/>
    <input id="searchTerm" placeholder="meeting"/>
    <button id="searchBtn">Search</button>
    <pre id="searchResults" class="small"></pre>
  </div>

  <hr/>

  <div>
    <button id="createSampleDraft">Create sample draft</button>
  </div>

  <hr/>

  <div>
    <button id="genICS">Generate .ics for 2 sample events</button>
    <a id="downloadIcs" style="display:none">Download ICS</a>
  </div>

<script>
  // Sidebar script
  document.getElementById('saveKey').addEventListener('click', async () => {
    const key = document.getElementById('apiKey').value.trim();
    await browser.storage.local.set({ openaiApiKey: key });
    document.getElementById('keyStatus').textContent = key ? 'Saved' : 'Cleared';
  });

  // load key
  (async () => {
    const s = await browser.storage.local.get('openaiApiKey');
    document.getElementById('apiKey').value = s.openaiApiKey || '';
  })();

  document.getElementById('readCurrent').addEventListener('click', async () => {
    const r = await browser.runtime.sendMessage({ type: 'getDisplayedMessage' });
    if (r.ok) {
      const m = r.message;
      const summary = `Subject: ${m.subject}\nFrom: ${m.author}\nDate: ${m.date}\n\n${m.parts?.map(p => p.body || '').join('\n').slice(0, 1000)}`;
      document.getElementById('messageSummary').textContent = summary;
    } else {
      document.getElementById('messageSummary').textContent = 'No message displayed';
    }
  });

  document.getElementById('searchBtn').addEventListener('click', async () => {
    const term = document.getElementById('searchTerm').value;
    const r = await browser.runtime.sendMessage({ type: 'searchMessages', query: { subjectContains: term, pageSize: 25 } });
    if (r.ok) {
      document.getElementById('searchResults').textContent = JSON.stringify(r.result.messages?.map(m => ({ id: m.id, subject: m.subject, author: m.author })) , null, 2);
    } else {
      document.getElementById('searchResults').textContent = 'Error: ' + r.error;
    }
  });

  document.getElementById('createSampleDraft').addEventListener('click', async () => {
    const r = await browser.runtime.sendMessage({ type: 'createDraft', subject: 'Draft from Copilot', body: 'This draft was created by Copilot.' });
    if (r.ok) alert('Draft created (composeTabId: ' + r.composeTabId + ')'); else alert('Error: ' + r.error);
  });

  document.getElementById('genICS').addEventListener('click', async () => {
    const events = [
      { uid: 'ev1', start: new Date().toISOString(), end: new Date(Date.now()+3600*1000).toISOString(), summary: 'Test meeting 1', description: 'Generated by Copilot', location: 'Zoom' },
      { uid: 'ev2', start: new Date(Date.now()+86400*1000).toISOString(), end: new Date(Date.now()+90000*1000).toISOString(), summary: 'Test meeting 2', description: 'Generated by Copilot', location: 'Office' }
    ];
    const r = await browser.runtime.sendMessage({ type: 'generateICS', events });
    if (r.ok) {
      const a = document.getElementById('downloadIcs');
      a.href = r.url;
      a.download = 'events.ics';
      a.style.display = 'inline-block';
      a.textContent = 'Download events.ics';
    } else {
      alert('ICS generation error');
    }
  });

  // Ask button - example call to OpenAI (uses fetch; user must have stored key)
  document.getElementById('ask').addEventListener('click', async () => {
    const s = await browser.storage.local.get('openaiApiKey');
    const key = s.openaiApiKey;
    if (!key) { document.getElementById('aiResponse').textContent = 'No API key saved.'; return; }
    const prompt = document.getElementById('prompt').value;
    document.getElementById('aiResponse').textContent = 'Calling OpenAI...';
    try {
      const resp = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + key, 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'gpt-4o', // replace as desired
          messages: [{ role: 'user', content: prompt }],
          max_tokens: 400
        })
      });
      const data = await resp.json();
      const text = (data.choices && data.choices[0] && (data.choices[0].message?.content || data.choices[0].text)) || JSON.stringify(data);
      document.getElementById('aiResponse').textContent = text;
    } catch (err) {
      document.getElementById('aiResponse').textContent = 'OpenAI error: ' + err;
    }
  });

  // Collapse toggle (just hide body for simple "collapse" UX)
  document.getElementById('toggle').addEventListener('click', () => {
    const body = document.body;
    if (body.style.display === 'none') { body.style.display = ''; document.getElementById('toggle').textContent = 'Collapse'; }
    else { body.style.display = 'none'; document.getElementById('toggle').textContent = 'Expand'; }
  });
</script>
</body>
</html>